# NGINX INGRESS CONTROLLER
version: "1"

env:
  MANIFEST_PATH: ${PROJECT_INFRASTRUCTURE}/manifests

options:
  interpolation: true
  session_clean_before: False
  session_clean_after: False

# helm repo add hkube http://hkube.io/helm/
targets:
  deploy:
    stages:
      deploy-nginx-ingress-controller:
        module: aziona.packages.kubernetes.helm
        args:
          --action: upgrade
          --action-args: |
            -i nginx-ingress 
            bitnami/nginx-ingress-controller
            --version 9.2.0
            --set-string service.externalTrafficPolicy=Local
            --set service.type=NodePort
            --set containerSecurityContext.allowPrivilegeEscalation=false
            --set publishService.enabled=true
            --set serviceAccount.create=true
            --set rbac.create=true
            --set metrics.enabled=true
            --set autoscaling.maxReplicas=5
            --set autoscaling.minReplicas=2
            --set autoscaling.enabled=true
            --namespace kube-system
            -f ${MANIFEST_PATH}/nginx-values.yaml  
      deploy-nginx-ingress-alb:
        module: aziona.packages.kubernetes.kubeaction
        args: 
          --manifest-path: ${MANIFEST_PATH}
          --manifest-yaml: 
            - alb-ingress-connect-nginx.yaml
          --action: apply 
  delete:
    stages:
      uninstall-nginx-ingress-controller:
        module: aziona.packages.kubernetes.helm
        args:
          --action: uninstall
          --action-args: |
            nginx-ingress 
            --namespace kube-system
      delete-nginx-ingress-alb:
        module: aziona.packages.kubernetes.kubeaction
        args: 
          --manifest-path: ${MANIFEST_PATH}
          --manifest-yaml: 
            - alb-ingress-connect-nginx.yaml
          --action: delete 