# NGINX INGRESS CONTROLLER
version: "1"

env:
  MANIFEST_PATH: ${INFRASTRUCTURE_PATH}/manifests

options:
  interpolation: true
  session_clean_before: False
  session_clean_after: False

# helm repo add hkube http://hkube.io/helm/
targets:
  test:
    stages:
      deploy-nginx-ingress-alb:
        module: aziona.packages.kubernetes.kubeaction
        args: 
          --manifest-path: ${MANIFEST_PATH}
          --manifest-yaml: 
            - alb-ingress-connect-nginx.yaml
          --action: apply 
  deploy:
    stages:
      deploy-nginx-ingress-controller:
        module: aziona.packages.kubernetes.helm
        args:
          --action: upgrade
          --action-args: |
            -i ingress-nginx
            ingress-nginx/ingress-nginx
            --version 4.2.3
            --set-string controller.service.externalTrafficPolicy=Local
            --set-string controller.service.type=NodePort
            --set controller.publishService.enabled=true
            --set serviceAccount.create=true
            --set rbac.create=true
            --set-string controller.config.server-tokens=false
            --set-string controller.config.use-proxy-protocol=false
            --set-string controller.config.compute-full-forwarded-for=true
            --set-string controller.config.use-forwarded-headers=true
            --set controller.metrics.enabled=true
            --set controller.autoscaling.maxReplicas=5
            --set controller.autoscaling.minReplicas=2
            --set controller.autoscaling.enabled=true
            --set controller.admissionWebhooks.enabled=false
            --namespace kube-system
            -f ${MANIFEST_PATH}/nginx-values.yaml  
      deploy-nginx-ingress-alb:
        module: aziona.packages.kubernetes.kubeaction
        args: 
          --manifest-path: ${MANIFEST_PATH}
          --manifest-yaml: 
            - alb-ingress-connect-nginx.yaml
          --action: apply 
  delete:
    stages:
      uninstall-nginx-ingress-controller:
        module: aziona.packages.kubernetes.helm
        args:
          --action: uninstall
          --action-args: |
            ingress-nginx
            --namespace kube-system
      delete-nginx-ingress-alb:
        module: aziona.packages.kubernetes.kubeaction
        args: 
          --manifest-path: ${MANIFEST_PATH}
          --manifest-yaml: 
            - alb-ingress-connect-nginx.yaml
          --action: delete 
