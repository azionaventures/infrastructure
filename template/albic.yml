# ALB INGRESS CONTROLLER
version: "1"

env:
  MANIFEST_PATH: ${PROJECT_INFRASTRUCTURE}/manifests
  POLICIES_PATH: ${PROJECT_INFRASTRUCTURE}/policies
  POLICY_NAME: AWSLoadBalancerControllerIAMPolicy
  INGRESS_CONTROLLER_ROLE: aws-load-balancer-controller
  ALB_VERSION: v2.4.1

options:
  interpolation: true
  session_clean_before: False
  session_clean_after: False

targets:
  create-iam-service-account:
    stages:
      create-policy:
        module: aziona.packages.aws.iam.create_policy
        args: 
          --policy-name: ${POLICY_NAME}
          --policy-file: ${POLICIES_PATH}/alb-iam-policy.json
          --account-id: ${ACCOUNT_ID}
          --session-save: ALB_POLICY
      eksctl-service-account:
        module: aziona.packages.kubernetes.iam_service_account
        args:
          --action: create
          --profile: ${ORGANIZATION_NAME}
          --cluster: ${EKS_CLUSTER_NAME}
          --region: ${EKS_AWS_REGION}
          --name: ${INGRESS_CONTROLLER_ROLE}
          --namespace: kube-system
          --attach-policy-arn: ${ALB_POLICY}
          --override-existing-serviceaccounts: 
          --approve:
        session: 
          - ALB_POLICY
  delete-iam-service-account:
    stages:
      eksctl-service-account:
        module: aziona.packages.kubernetes.iam_service_account
        args:
          --action: delete
          --profile: ${ORGANIZATION_NAME}
          --cluster: ${EKS_CLUSTER_NAME}
          --region: ${EKS_AWS_REGION}
          --name: ${INGRESS_CONTROLLER_ROLE}
          --namespace: kube-system
      delete-policy:
        before: 
          sleep: sleep 20
        module: aziona.packages.aws.iam.delete_policy
        args: 
          --policy-name: ${POLICY_NAME}
          --account-id: ${ACCOUNT_ID}

  create-addon:
    stages:
      vpc-id:
        module: aziona.packages.kubernetes.eksctl
        args:
          --action: create
          --action-args: |
            addon
            --name vpc-cni 
            --version v1.11.0-eksbuild.1 
            --cluster ${EKS_CLUSTER_NAME} 
            --service-account-role-arn arn:aws:iam::${ACCOUNT_ID}:role/AmazonEKSVPCCNIRole 
            --force
      nginx:
        module: aziona.packages.kubernetes.eksctl
        args:
          --action: create
          --action-args: |
            addon
            --name kube-proxy 
            --cluster ${EKS_CLUSTER_NAME} 
            --force
      coredns:
        module: aziona.packages.kubernetes.eksctl
        args:
          --action: create
          --action-args: |
            addon
            --name coredns 
            --cluster ${EKS_CLUSTER_NAME}
            --force

  deploy:
    stages:
      vpc-id:
        module: aziona.packages.aws.awscli
        args:
          --action: eks
          --profile: ${ORGANIZATION_NAME}
          --jq-query: |
            .cluster.resourcesVpcConfig.vpcId
          --action-args: |
            describe-cluster
            --region ${EKS_AWS_REGION}
            --output json
            --name ${EKS_CLUSTER_NAME}
          --session-save: AWS_VPC_ID
      deploy-alb-vpc-id:
        module: aziona.packages.aws.awscli
        session:
          - AWS_VPC_ID
        args:
          --action: eks
          --profile: ${ORGANIZATION_NAME}
          --jq-query: |
            .cluster.resourcesVpcConfig.vpcId
          --action-args: |
            describe-cluster
            --region ${EKS_AWS_REGION}
            --output json
            --name ${EKS_CLUSTER_NAME}
        after:
          deploy: | 
            helm repo add bitnami https://charts.bitnami.com/bitnami
            helm install aws-load-balancer-controller eks/aws-load-balancer-controller \
              -n kube-system \
              --set clusterName=${EKS_CLUSTER_NAME} \
              --set serviceAccount.create=false \
              --set serviceAccount.name=aws-load-balancer-controller  \
              --set vpcId=${AWS_VPC_ID} \
              --set region=${EKS_AWS_REGION}
      
  delete:
    stages:
      delete-alb:
        module: aziona.packages.kubernetes.helm
        args:
          --action: uninstall
          --action-args: |
            aws-load-balancer-controller 
            --namespace kube-system